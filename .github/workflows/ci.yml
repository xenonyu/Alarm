name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  SCHEME: Alarm
  SIMULATOR: "iPhone 16"
  DERIVED_DATA: /tmp/AlarmBuild

jobs:
  # ── Build ──────────────────────────────────────────────────────────────────
  build:
    name: Build
    runs-on: macos-15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Show environment
        run: |
          xcodebuild -version
          xcrun simctl list devicetypes | grep iPhone | tail -5

      - name: Cache Homebrew
        uses: actions/cache@v4
        with:
          path: ~/Library/Caches/Homebrew
          key: brew-xcodegen-${{ runner.os }}-${{ hashFiles('project.yml') }}
          restore-keys: brew-xcodegen-${{ runner.os }}-

      - name: Install tools
        run: |
          brew install xcodegen
          gem install xcpretty --no-document

      - name: Generate Xcode project
        run: xcodegen generate

      - name: Build for Simulator
        run: |
          set -o pipefail
          xcodebuild build \
            -project ${{ env.SCHEME }}.xcodeproj \
            -scheme  ${{ env.SCHEME }} \
            -destination "platform=iOS Simulator,name=${{ env.SIMULATOR }}" \
            -derivedDataPath ${{ env.DERIVED_DATA }} \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            | xcpretty; exit ${PIPESTATUS[0]}

      - name: Upload build logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: |
            ${{ env.DERIVED_DATA }}/Logs
            xcodebuild.log

  # ── UI Tests ───────────────────────────────────────────────────────────────
  test:
    name: UI Tests
    runs-on: macos-15
    needs: build

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Cache Homebrew
        uses: actions/cache@v4
        with:
          path: ~/Library/Caches/Homebrew
          key: brew-xcodegen-${{ runner.os }}-${{ hashFiles('project.yml') }}
          restore-keys: brew-xcodegen-${{ runner.os }}-

      - name: Install tools
        run: |
          brew install xcodegen
          gem install xcpretty --no-document

      - name: Generate Xcode project
        run: xcodegen generate

      - name: Run UI Tests
        run: |
          set -o pipefail
          xcodebuild test \
            -project ${{ env.SCHEME }}.xcodeproj \
            -scheme  ${{ env.SCHEME }} \
            -destination "platform=iOS Simulator,name=${{ env.SIMULATOR }}" \
            -derivedDataPath ${{ env.DERIVED_DATA }} \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            | xcpretty --report junit --output test-results.xml; exit ${PIPESTATUS[0]}

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: test-results.xml

  # ── Release / TestFlight (manual trigger only) ────────────────────────────
  # Uncomment and configure secrets to enable TestFlight distribution.
  #
  # release:
  #   name: TestFlight
  #   runs-on: macos-15
  #   if: github.ref == 'refs/heads/main' && github.event_name == 'push'
  #   needs: test
  #   environment: testflight
  #
  #   steps:
  #     - uses: actions/checkout@v4
  #
  #     - uses: maxim-lobanov/setup-xcode@v1
  #       with:
  #         xcode-version: latest-stable
  #
  #     - name: Import certificate
  #       env:
  #         CERT_P12: ${{ secrets.CERTIFICATE_P12_BASE64 }}
  #         CERT_PWD:  ${{ secrets.CERTIFICATE_PASSWORD }}
  #       run: |
  #         echo "$CERT_P12" | base64 --decode > cert.p12
  #         security create-keychain -p "" build.keychain
  #         security import cert.p12 -k build.keychain -P "$CERT_PWD" -T /usr/bin/codesign
  #         security set-key-partition-list -S apple-tool:,apple: -s -k "" build.keychain
  #         security list-keychains -d user -s build.keychain
  #
  #     - name: Import provisioning profile
  #       run: |
  #         echo "${{ secrets.PROVISIONING_PROFILE_BASE64 }}" | base64 --decode > profile.mobileprovision
  #         mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
  #         cp profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/
  #
  #     - name: Install XcodeGen & generate project
  #       run: brew install xcodegen && xcodegen generate
  #
  #     - name: Archive
  #       run: |
  #         xcodebuild archive \
  #           -project Alarm.xcodeproj \
  #           -scheme Alarm \
  #           -archivePath Alarm.xcarchive \
  #           -destination "generic/platform=iOS"
  #
  #     - name: Export IPA
  #       run: |
  #         xcodebuild -exportArchive \
  #           -archivePath Alarm.xcarchive \
  #           -exportPath . \
  #           -exportOptionsPlist ExportOptions.plist
  #
  #     - name: Upload to TestFlight
  #       env:
  #         API_KEY_ID:    ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
  #         API_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}
  #         API_KEY:       ${{ secrets.APP_STORE_CONNECT_API_KEY_BASE64 }}
  #       run: |
  #         echo "$API_KEY" | base64 --decode > AuthKey.p8
  #         xcrun altool --upload-app \
  #           --type ios \
  #           --file Alarm.ipa \
  #           --apiKey "$API_KEY_ID" \
  #           --apiIssuer "$API_ISSUER_ID" \
  #           --private-key AuthKey.p8
